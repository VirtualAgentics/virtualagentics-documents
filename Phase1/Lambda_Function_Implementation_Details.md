---
title: "Detailed Lambda Function Implementation (Phase 1) – Virtual Agentics"
status: "Stable Draft"
audience: "Internal (Engineering, DevOps, Security); External (Auditors)"
authors: "VirtualAgentics Core Team (generated by ChatGPT GPT-4.5, curated by Ben)"
version: "1.0"
date: "2025-06-06"
gpt_model: "Drafted by GPT-4.5 Deep Research"
---

# Detailed Lambda Function Implementation – Phase 1

## Purpose

This document captures all implementation details for AWS Lambda functions created during Phase 1 of Virtual Agentics. It includes function roles, triggers, runtime, CI/CD integration, IAM, and security as provisioned by infrastructure-as-code.

---

## 1. Overview of Lambda Functions

| Lambda Name                   | Purpose                                 | Trigger/Event Source           | Runtime      | IAM Role                         |
|-------------------------------|-----------------------------------------|-------------------------------|--------------|-----------------------------------|
| va-prod-contentgen-lambda     | Generates content/articles via OpenAI   | API Gateway, EventBridge      | Python 3.11  | va-prod-lambda-contentgen-role    |
| va-prod-afflink-lambda        | Enriches content with affiliate links   | S3 (Put), EventBridge         | Python 3.11  | va-prod-lambda-afflink-role       |
| va-prod-emailtemplate-lambda  | Generates templated email content       | EventBridge, manual           | Python 3.11  | va-prod-lambda-emailtemplate-role |
| va-prod-workflow-orch-lambda  | Orchestrates multi-agent workflows      | EventBridge, Schedule         | Python 3.11  | va-prod-lambda-orch-role          |

---

## 2. Common Lambda Configuration

- **Runtime:** Python 3.11 (all Phase 1 functions)
- **Deployment:** Code packaged via CI/CD (GitHub Actions), zipped and deployed by Terraform or directly via AWS CLI
- **VPC Attachment:** As required (typically private subnets per [AWS_Addressing_Plan.md](../AWS_Addressing_Plan.md))
- **Environment Variables:** Set via Terraform (e.g., `OPENAI_API_KEY`, S3 bucket names, table names)
- **Timeout:** Default 30 seconds; configured per use-case
- **Memory:** Default 256MB; increased for model calls if required
- **Logging:** All logs sent to `/aws/lambda/<function-name>` in CloudWatch

---

## 3. Function Implementation Details

### a) Content Generation Lambda (`va-prod-contentgen-lambda`)

- **Purpose:** Generate blog articles or knowledge content using GPT models (OpenAI via API).
- **Trigger:** 
  - API Gateway (REST endpoint for content requests)
  - Scheduled runs (CloudWatch Events/EventBridge for periodic batch)
- **IAM Permissions:**
  - Read `OPENAI_API_KEY` from Secrets Manager
  - Write generated content to DynamoDB table (`va-prod-core-dynamodb`)
  - Write content artifacts to S3 bucket (`va-prod-content-bucket`)
  - Write logs to CloudWatch
- **Code structure:**
  - `handler(event, context)`: Validates input, invokes OpenAI API, parses response, writes to DynamoDB/S3, logs result.
- **Security:** No secrets in code; only fetches key from Secrets Manager at runtime.

### b) Affiliate Link Lambda (`va-prod-afflink-lambda`)

- **Purpose:** Scan generated content, detect product mentions, insert affiliate links.
- **Trigger:** 
  - S3 Put event (new content file uploaded)
  - EventBridge event (content publish request)
- **IAM Permissions:**
  - Read/write to S3 bucket (`va-prod-content-bucket`)
  - Update DynamoDB record for enriched content
  - Write logs to CloudWatch
- **Code structure:**
  - `handler(event, context)`: Loads file from S3, parses content, inserts links, updates S3 and DynamoDB, logs result.
- **Security:** Uses IAM policy with least-privilege S3 and DynamoDB access.

### c) Email Template Lambda (`va-prod-emailtemplate-lambda`)

- **Purpose:** Generate customized email templates for notifications (e.g., new content published, approval required).
- **Trigger:** 
  - EventBridge event (notification request)
  - Direct API call (for future extensibility)
- **IAM Permissions:**
  - Write to SES/WorkMail (for sending)
  - Log email generation to CloudWatch
- **Code structure:**
  - `handler(event, context)`: Accepts notification event, generates templated message, sends via SES/WorkMail, logs result.

### d) Workflow Orchestrator Lambda (`va-prod-workflow-orch-lambda`)

- **Purpose:** Orchestrate multi-step workflows (e.g., content gen → review → publish).
- **Trigger:** 
  - EventBridge scheduled trigger (e.g., every X minutes)
  - Manual execution via AWS Console for ad hoc testing
- **IAM Permissions:**
  - Invoke other Lambda functions (as needed by workflow)
  - Publish events to EventBridge/SNS topics
  - Log workflow runs to CloudWatch
- **Code structure:**
  - `handler(event, context)`: State machine pattern, coordinates calls to contentgen, afflink, emailtemplate Lambdas, tracks progress, logs all steps.

---

## 4. CI/CD and Deployment

- **Source:** `virtualagentics-lambdas` GitHub repository
- **Build/Test:** GitHub Actions workflow per Lambda subdirectory (test, zip)
- **Deployment:** GitHub Actions triggers `aws lambda update-function-code` via OIDC-assumed IAM role, or uploads zip for Terraform deployment
- **Branch Protection:** Only deploy from protected branches (`main`), PR reviews required
- **Secrets Management:** No AWS credentials or API keys in code; all injected via environment variables and IAM access

---

## 5. Monitoring, Logging, and Alerts

- **CloudWatch Logs:** Enabled for all functions
- **Alarms:** Set on error count, duration, and throttling for each Lambda (see [Monitoring_and_Alerting.md](../Monitoring_and_Alerting.md))
- **Dashboards:** Lambda metrics included in CloudWatch Dashboards for operations
- **DLQ:** Dead-letter queue configured where appropriate for failed executions

---

## 6. Security, Compliance, and Auditing

- **IAM Policies:** Strict least-privilege for each Lambda role, only the minimal set of allowed actions
- **Environment Segregation:** Separate Lambdas for prod, dev, etc., each with separate roles and permissions
- **Tagging:** All functions tagged (`Name`, `Environment`, `Purpose`, `Project`)
- **Audit:** All invocations, errors, and key actions are logged, with audit trail via CloudTrail

---

## 7. References

- [AWS_Lambda_Runtime_and_Configuration.md](AWS_Lambda_Runtime_and_Configuration.md)
- [Naming_Conventions.md](../Naming_Conventions.md)
- [Terraform_Bootstrapping_Phase1.md](Terraform_Bootstrapping_Phase1.md)
- [Monitoring_and_Alerting.md](../Monitoring_and_Alerting.md)
- Source: "Detailed_Lambda_Function_Implementation_Phase1.docx", "Phase 1 – Lambda Function Implementation Details.pdf"

---

*End of document*
