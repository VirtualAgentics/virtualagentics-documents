---
title: "Detailed Lambda Function Implementation (Phase 1) – Virtual Agentics"
status: "Stable Draft"
audience: "Internal (Engineering, DevOps, Security); External (Auditors)"
authors: "VirtualAgentics Core Team (generated by ChatGPT GPT-4.5, curated by Ben)"
version: "1.0"
date: "2025-06-06"
gpt_model: "Drafted by GPT-4.5 Deep Research"
---

# Detailed Lambda Function Implementation – Phase 1

## Purpose

This document captures all implementation details for AWS Lambda functions created during Phase 1 of Virtual Agentics. It includes function roles, triggers, runtime, CI/CD integration, IAM, and security as provisioned by infrastructure-as-code.

---

## 1. Overview of Lambda Functions

| Lambda Name                   | Purpose                                 | Trigger/Event Source           | Runtime      | IAM Role                         |
|-------------------------------|-----------------------------------------|-------------------------------|--------------|-----------------------------------|
| va-prod-contentgen-lambda     | Generates content/articles via OpenAI   | API Gateway, EventBridge      | Python 3.11  | va-prod-lambda-contentgen-role    |
| va-prod-afflink-lambda        | Enriches content with affiliate links   | S3 (Put), EventBridge         | Python 3.11  | va-prod-lambda-afflink-role       |
| va-prod-emailtemplate-lambda  | Generates templated email content       | EventBridge, manual           | Python 3.11  | va-prod-lambda-emailtemplate-role |
| va-prod-workflow-orch-lambda  | Orchestrates multi-agent workflows      | EventBridge, Schedule         | Python 3.11  | va-prod-lambda-orch-role          |

---

## 2. Common Lambda Configuration

- **Runtime:** Python 3.11 (all Phase 1 functions)
- **Deployment:** Code packaged via CI/CD (GitHub Actions), zipped and deployed by Terraform or directly via AWS CLI
- **VPC Attachment:** As required (typically private subnets per [[AWS Addressing Plan](../AWS_Addressing_Plan.md#3-subnet-structure-per-vpc)](../[AWS Addressing Plan](../AWS_Addressing_Plan.md#3-subnet-structure-per-vpc)))
- **Environment Variables:** Set via Terraform (e.g., `OPENAI_API_KEY`, S3 bucket names, table names)
- **Timeout:** Default 30 seconds; configured per use-case
- **Memory:** Default 256MB; increased for model calls if required
- **Logging:** All logs sent to `/aws/lambda/<function-name>` in CloudWatch

---

## 3. Function Implementation Details

### a) Content Generation Lambda (`va-prod-contentgen-lambda`)

#### Simplified Lambda Handler Pseudocode

```python
def handler(event, context):
    # Fetch API key securely from Secrets Manager
    api_key = get_secret("OPENAI_API_KEY")

    # Validate incoming event
    validate_event(event)

    # Invoke external API (OpenAI)
    response = invoke_openai_api(api_key, event['content_request'])

    # Store results
    write_to_dynamodb(response['metadata'])
    write_to_s3(response['content_file'])

    # Log success or errors
    log_event_outcome(response)
```


- **Purpose:** Generate blog articles or knowledge content using GPT models (OpenAI via API).
- **Trigger:** 
  - API Gateway (REST endpoint for content requests)
  - Scheduled runs (CloudWatch Events/EventBridge for periodic batch)
- **IAM Permissions:**

#### Example IAM Policy JSON (Least Privilege)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:eu-central-1:123456789012:secret:va/prod/openai-api-key*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:eu-central-1:123456789012:table/va-prod-core-dynamodb"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::va-prod-content-bucket/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": [
        "arn:aws:logs:eu-central-1:123456789012:log-group:/aws/lambda/va-prod-contentgen-lambda:*"
      ]
    }
  ]
}
```

  - Read `OPENAI_API_KEY` from Secrets Manager
  - Write generated content to DynamoDB table (`va-prod-core-dynamodb`)
  - Write content artifacts to S3 bucket (`va-prod-content-bucket`)
  - Write logs to CloudWatch
- **Code structure:**
  - `handler(event, context)`: Validates input, invokes OpenAI API, parses response, writes to DynamoDB/S3, logs result.
- **Security:** No secrets in code; only fetches key from Secrets Manager at runtime.

### b) Affiliate Link Lambda (`va-prod-afflink-lambda`)

- **Purpose:** Scan generated content, detect product mentions, insert affiliate links.
- **Trigger:** 
  - S3 Put event (new content file uploaded)
  - EventBridge event (content publish request)
- **IAM Permissions:**

#### Example IAM Policy JSON (Least Privilege)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:eu-central-1:123456789012:secret:va/prod/openai-api-key*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:eu-central-1:123456789012:table/va-prod-core-dynamodb"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::va-prod-content-bucket/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": [
        "arn:aws:logs:eu-central-1:123456789012:log-group:/aws/lambda/va-prod-contentgen-lambda:*"
      ]
    }
  ]
}
```

  - Read/write to S3 bucket (`va-prod-content-bucket`)
  - Update DynamoDB record for enriched content
  - Write logs to CloudWatch
- **Code structure:**
  - `handler(event, context)`: Loads file from S3, parses content, inserts links, updates S3 and DynamoDB, logs result.
- **Security:** Uses IAM policy with least-privilege S3 and DynamoDB access.

### c) Email Template Lambda (`va-prod-emailtemplate-lambda`)

- **Purpose:** Generate customized email templates for notifications (e.g., new content published, approval required).
- **Trigger:** 
  - EventBridge event (notification request)
  - Direct API call (for future extensibility)
- **IAM Permissions:**

#### Example IAM Policy JSON (Least Privilege)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:eu-central-1:123456789012:secret:va/prod/openai-api-key*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:eu-central-1:123456789012:table/va-prod-core-dynamodb"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::va-prod-content-bucket/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": [
        "arn:aws:logs:eu-central-1:123456789012:log-group:/aws/lambda/va-prod-contentgen-lambda:*"
      ]
    }
  ]
}
```

  - Write to SES/WorkMail (for sending)
  - Log email generation to CloudWatch
- **Code structure:**
  - `handler(event, context)`: Accepts notification event, generates templated message, sends via SES/WorkMail, logs result.

### d) Workflow Orchestrator Lambda (`va-prod-workflow-orch-lambda`)

- **Purpose:** Orchestrate multi-step workflows (e.g., content gen → review → publish).
- **Trigger:** 
  - EventBridge scheduled trigger (e.g., every X minutes)
  - Manual execution via AWS Console for ad hoc testing
- **IAM Permissions:**

#### Example IAM Policy JSON (Least Privilege)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": [
        "arn:aws:secretsmanager:eu-central-1:123456789012:secret:va/prod/openai-api-key*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:eu-central-1:123456789012:table/va-prod-core-dynamodb"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::va-prod-content-bucket/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": [
        "arn:aws:logs:eu-central-1:123456789012:log-group:/aws/lambda/va-prod-contentgen-lambda:*"
      ]
    }
  ]
}
```

  - Invoke other Lambda functions (as needed by workflow)
  - Publish events to EventBridge/SNS topics
  - Log workflow runs to CloudWatch
- **Code structure:**
  - `handler(event, context)`: State machine pattern, coordinates calls to contentgen, afflink, emailtemplate Lambdas, tracks progress, logs all steps.

---

## 4. CI/CD and Deployment

### Lambda Function Packaging

All Lambda functions use a standardized packaging approach:

- Dependencies listed explicitly in `requirements.txt`
- GitHub Actions CI/CD pipeline installs dependencies:
  ```bash
  pip install -r requirements.txt -t ./package
  ```
- Code zipped along with dependencies:
  ```bash
  zip -r lambda_function_payload.zip .
  ```
- Artifacts uploaded directly via Terraform or AWS CLI during deployment


- **Source:** `virtualagentics-lambdas` GitHub repository
- **Build/Test:** GitHub Actions workflow per Lambda subdirectory (test, zip)
- **Deployment:** GitHub Actions triggers `aws lambda update-function-code` via OIDC-assumed IAM role, or uploads zip for Terraform deployment
- **Branch Protection:** Only deploy from protected branches (`main`), PR reviews required
- **Secrets Management:** No AWS credentials or API keys in code; all injected via environment variables and IAM access

---

## 5. Monitoring, Logging, and Alerts

- **CloudWatch Logs:** Enabled for all functions
- **Alarms:** Set on error count, duration, and throttling for each Lambda (see [[Monitoring and Alerting](../Monitoring_and_Alerting.md)](../[Monitoring and Alerting](../Monitoring_and_Alerting.md)))
- **Dashboards:** Lambda metrics included in CloudWatch Dashboards for operations
- **DLQ:** Dead-letter queue configured where appropriate for failed executions

---

## 6. Security, Compliance, and Auditing

- **IAM Policies:** Strict least-privilege for each Lambda role, only the minimal set of allowed actions
- **Environment Segregation:** Separate Lambdas for prod, dev, etc., each with separate roles and permissions
- **Tagging:** All functions tagged (`Name`, `Environment`, `Purpose`, `Project`)
- **Audit:** All invocations, errors, and key actions are logged, with audit trail via CloudTrail

---

## 7. References

- [[AWS Lambda Runtime and Configuration](AWS_Lambda_Runtime_and_Configuration.md#api-gateway-integration)]([AWS Lambda Runtime and Configuration](AWS_Lambda_Runtime_and_Configuration.md#api-gateway-integration))
- [[Naming Conventions](../Naming_Conventions.md)](../[Naming Conventions](../Naming_Conventions.md))
- [Terraform_Bootstrapping_Phase1.md](Terraform_Bootstrapping_Phase1.md)
- [[Monitoring and Alerting](../Monitoring_and_Alerting.md)](../[Monitoring and Alerting](../Monitoring_and_Alerting.md))
- Source: "Detailed_Lambda_Function_Implementation_Phase1.docx", "Phase 1 – Lambda Function Implementation Details.pdf"

---

*End of document*

## Appendix: Full IAM Policy Documents (Phase 1 Lambdas)

### Content Generation Lambda (`va-prod-lambda-contentgen-role`)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["secretsmanager:GetSecretValue"],
      "Resource": ["arn:aws:secretsmanager:<region>:<account-id>:secret:va/prod/openai-api-key*"]
    },
    {
      "Effect": "Allow",
      "Action": ["dynamodb:PutItem"],
      "Resource": ["arn:aws:dynamodb:<region>:<account-id>:table/va-prod-core-dynamodb"]
    },
    {
      "Effect": "Allow",
      "Action": ["s3:PutObject"],
      "Resource": ["arn:aws:s3:::va-prod-content-bucket/*"]
    },
    {
      "Effect": "Allow",
      "Action": ["logs:CreateLogStream", "logs:PutLogEvents"],
      "Resource": ["arn:aws:logs:<region>:<account-id>:log-group:/aws/lambda/va-prod-contentgen-lambda:*"]
    }
  ]
}
```

### Affiliate Link Lambda (`va-prod-lambda-afflink-role`)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["s3:GetObject", "s3:PutObject"],
      "Resource": ["arn:aws:s3:::va-prod-content-bucket/*"]
    },
    {
      "Effect": "Allow",
      "Action": ["dynamodb:UpdateItem"],
      "Resource": ["arn:aws:dynamodb:<region>:<account-id>:table/va-prod-core-dynamodb"]
    },
    {
      "Effect": "Allow",
      "Action": ["logs:CreateLogStream", "logs:PutLogEvents"],
      "Resource": ["arn:aws:logs:<region>:<account-id>:log-group:/aws/lambda/va-prod-afflink-lambda:*"]
    }
  ]
}
```

### Email Template Lambda (`va-prod-lambda-emailtemplate-role`)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["ses:SendEmail"],
      "Resource": ["arn:aws:ses:<region>:<account-id>:identity/virtualagentics.ai"]
    },
    {
      "Effect": "Allow",
      "Action": ["logs:CreateLogStream", "logs:PutLogEvents"],
      "Resource": ["arn:aws:logs:<region>:<account-id>:log-group:/aws/lambda/va-prod-emailtemplate-lambda:*"]
    }
  ]
}
```

### Workflow Orchestrator Lambda (`va-prod-lambda-orch-role`)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["lambda:InvokeFunction"],
      "Resource": ["arn:aws:lambda:<region>:<account-id>:function:va-prod-*"]
    },
    {
      "Effect": "Allow",
      "Action": ["events:PutEvents"],
      "Resource": ["arn:aws:events:<region>:<account-id>:event-bus/default"]
    },
    {
      "Effect": "Allow",
      "Action": ["logs:CreateLogStream", "logs:PutLogEvents"],
      "Resource": ["arn:aws:logs:<region>:<account-id>:log-group:/aws/lambda/va-prod-orch-lambda:*"]
    }
  ]
}
```

## API Gateway Integration (Content Generation Lambda)

- **Method**: POST
- **Endpoint**: `/generate-content`
- **Integration type**: AWS_PROXY (Lambda Proxy Integration)

```hcl
resource "aws_api_gateway_rest_api" "content_gen_api" {
  name        = "va-prod-contentgen-api"
  description = "API Gateway for content generation"
}

resource "aws_api_gateway_resource" "content_resource" {
  rest_api_id = aws_api_gateway_rest_api.content_gen_api.id
  parent_id   = aws_api_gateway_rest_api.content_gen_api.root_resource_id
  path_part   = "generate-content"
}

resource "aws_api_gateway_method" "content_method" {
  rest_api_id   = aws_api_gateway_rest_api.content_gen_api.id
  resource_id   = aws_api_gateway_resource.content_resource.id
  http_method   = "POST"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "content_integration" {
  rest_api_id             = aws_api_gateway_rest_api.content_gen_api.id
  resource_id             = aws_api_gateway_resource.content_resource.id
  http_method             = aws_api_gateway_method.content_method.http_method
  integration_http_method = "POST"
  type                    = "AWS_PROXY"
  uri                     = aws_lambda_function.content_gen_lambda.invoke_arn
}
```

### OpenAI API Integration

- API called securely over HTTPS using NAT Gateway in VPC.
- API key stored explicitly in AWS Secrets Manager (`va/prod/openai-api-key`).
- Lambda fetches API keys securely at runtime.
