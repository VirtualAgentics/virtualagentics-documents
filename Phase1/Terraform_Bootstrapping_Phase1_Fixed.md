---
title: "Terraform Bootstrapping Guide (Phase 1) â€“ Virtual Agentics"
status: "Stable Draft"
audience: "Internal (DevOps, Cloud, Security); External (Auditors, Stakeholders)"
authors: "VirtualAgentics Core Team (generated by ChatGPT GPT-4.5, curated by Ben)"
version: "1.0"
date: "2025-06-06"
gpt_model: "Drafted by GPT-4.5 Deep Research"
---

# Terraform Bootstrapping Guide (Phase 1): Virtual Agentics

## Purpose

This document describes the step-by-step process for bootstrapping the initial AWS infrastructure for Virtual Agentics using Terraform. It covers the remote state backend, repository setup, and all naming/addressing conventions, as well as secure automation via CI/CD.

---

## 1. Prerequisites

- **AWS root account** with billing access, organization created with Control Tower (see [AWS_Control_Tower_Setup.md](AWS_Control_Tower_Setup.md))
- **Terraform 1.5+** and AWS CLI installed locally or in CI/CD runners
- **GitHub account** (`VirtualAgentics`) and infra repo (`virtualagentics-iac`)
- **Naming and address plan**: All names, tags, and CIDRs per [Naming_Conventions.md](../Naming_Conventions.md) and [AWS_Addressing_Plan.md](../AWS_Addressing_Plan.md)
- **Project structure**: All code and state tracked in Git, no manual console changes except break-glass

---

## 2. High-Level Bootstrapping Steps

### Clarification: Control Tower Account Provisioning

- **Account and OU creation:** Managed manually through AWS Control Tower initial setup for core accounts (Management, Audit, Log Archive). Terraform currently **does not** automate these initial accounts due to Control Tower limitations.
- **Guardrails:** Can be explicitly managed via Terraform using AWS Control Tower Terraform provider (`awscc_controltower_control`), but initial baseline guardrails are currently set manually during the Control Tower setup.


1. **Prepare AWS Organization/Accounts** via Control Tower (Management, Audit, Log Archive, Prod, Dev, Shared, Sandbox)
2. **Create remote Terraform backend** (S3 bucket, DynamoDB lock table)
3. **Configure and initialize Terraform project/repository**
4. **Set up IAM roles for CI/CD and deployment**
5. **Define and apply initial network, IAM, and foundation modules**
6. **Enable automated CI/CD pipeline for Terraform**

---

## 3. Remote Backend Setup

### a) S3 Bucket (for Terraform state)

- Name: `va-prod-terraform-state`
- Region: `eu-central-1`
- Settings: Versioning **ON**, encryption **ON**

```bash
aws s3api create-bucket --bucket va-prod-terraform-state --region eu-central-1 --create-bucket-configuration LocationConstraint=eu-central-1
aws s3api put-bucket-versioning --bucket va-prod-terraform-state --versioning-configuration Status=Enabled
aws s3api put-bucket-encryption --bucket va-prod-terraform-state --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'
```

### b) DynamoDB Table (for lock/state)

- Name: `va-prod-terraform-lock`
- Primary key: `LockID` (string)
- Billing: On-demand

```bash
aws dynamodb create-table --table-name va-prod-terraform-lock   --attribute-definitions AttributeName=LockID,AttributeType=S   --key-schema AttributeName=LockID,KeyType=HASH   --billing-mode PAY_PER_REQUEST
```

### c) Terraform Backend Block

In your root `main.tf` or `backend.tf`:

```hcl
terraform {
  backend "s3" {
    bucket         = "va-prod-terraform-state"
    key            = "prod/terraform.tfstate"
    region         = "eu-central-1"
    dynamodb_table = "va-prod-terraform-lock"
    encrypt        = true
  }
}
```

---

## 4. Project Repository and Structure
### Comprehensive Network Topology Diagram

```mermaid
graph TB;
    subgraph "va-prod-core-vpc (10.0.0.0/16)"
        PUB_A["Public Subnet AZ-A (10.0.1.0/24)"]
        PUB_B["Public Subnet AZ-B (10.0.2.0/24)"]
        PRIV_A["Private Subnet AZ-A (10.0.10.0/24)"]
        PRIV_B["Private Subnet AZ-B (10.0.11.0/24)"]
        ISO_A["Isolated Subnet AZ-A (10.0.20.0/24)"]
        ISO_B["Isolated Subnet AZ-B (10.0.21.0/24)"]
    end
    subgraph "va-dev-core-vpc (10.2.0.0/16)"
        DEV_PUB_A["Public Subnet AZ-A (10.2.1.0/24)"]
        DEV_PRIV_A["Private Subnet AZ-A (10.2.10.0/24)"]
    end
    subgraph "va-shared-infra-vpc (10.4.0.0/16)"
        SHARED_PUB_A["Public Subnet AZ-A (10.4.1.0/24)"]
        SHARED_PRIV_A["Private Subnet AZ-A (10.4.10.0/24)"]
    end
    INTERNET["Internet Gateway"]
    INTERNET --> PUB_A
    INTERNET --> PUB_B
    INTERNET --> DEV_PUB_A
    INTERNET --> SHARED_PUB_A
    PUB_A --> NAT_GW_A["NAT Gateway AZ-A"]
    PUB_B --> NAT_GW_B["NAT Gateway AZ-B"]
    DEV_PUB_A --> DEV_NAT["Dev NAT Gateway"]
    SHARED_PUB_A --> SHARED_NAT["Shared NAT Gateway"]
    PRIV_A --> NAT_GW_A
    PRIV_B --> NAT_GW_B
    DEV_PRIV_A --> DEV_NAT
    SHARED_PRIV_A --> SHARED_NAT
```



### Terraform Modules Overview

Explicitly managed Terraform modules in the `virtualagentics-iac` repository:

- **VA-VPC Module** (`modules/va-vpc`): Defines foundational VPC and subnet layout.
- **VA-IAM Module** (`modules/va-iam`): Centralized IAM roles and policies.
- **VA-Lambda Module** (`modules/va-lambda`): Standardized Lambda function deployment.
- **VA-Route53 Module** (`modules/va-route53`): DNS configurations for primary and subdomains.
- **VA-WorkMail Module** (`modules/va-workmail`): Email configuration and alias management.
- **VA-Security Module** (`modules/va-security`): Baseline security groups and rules.
- **VA-S3 Module** (`modules/va-s3`): Standard bucket setups for Terraform state and application data.



- Repo: `virtualagentics-iac` on GitHub
- Branching: `main` (protected), `dev` (optional), PR reviews required
- Directory layout:
  - `/modules/` (for reusable VPC, IAM, Lambda modules, etc.)
  - `/environments/prod/` (prod root, backend config, main.tf)
  - `/environments/dev/` (for later expansion)

- README and comments must reference [Naming_Conventions.md](../Naming_Conventions.md), [AWS_Addressing_Plan.md](../AWS_Addressing_Plan.md)

---

## 5. Initial IAM Roles and OIDC Integration

### Example Terraform Resource Definition: IAM Role for Terraform CI/CD

```hcl
resource "aws_iam_role" "terraform_ci_cd_role" {
  name = "va-prod-core-terraform-iam-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Effect = "Allow",
      Principal = {
        Federated = "arn:aws:iam::<ACCOUNT_ID>:oidc-provider/token.actions.githubusercontent.com"
      },
      Action = "sts:AssumeRoleWithWebIdentity",
      Condition = {
        StringEquals = {
          "token.actions.githubusercontent.com:sub": "repo:VirtualAgentics/virtualagentics-iac:*"
        }
      }
    }]
  })

  inline_policy {
    name = "TerraformCIPermissions"
    policy = jsonencode({
      Version = "2012-10-17",
      Statement = [{
        Effect = "Allow",
        Action = "*",
        Resource = "*"
      }]
    })
  }

  tags = {
    Name        = "va-prod-core-terraform-iam-role"
    Environment = "prod"
    Project     = "VirtualAgentics"
  }
}
```


- **Terraform CI/CD Role:** `va-prod-core-terraform-iam-role`
  - Trusted via GitHub OIDC provider (`token.actions.githubusercontent.com`)
  - Permissions: Admin for bootstrap, then reduced to least-privilege for ongoing changes

**Trust Policy Example:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::<ACCOUNT_ID>:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:sub": "repo:VirtualAgentics/virtualagentics-iac:*"
        }
      }
    }
  ]
}
```

---

## 6. Example Minimal `main.tf` for Phase 1

```hcl
provider "aws" {
  region = "eu-central-1"
}

module "vpc" {
  source     = "./modules/vpc"
  vpc_name   = "va-prod-core-vpc"
  cidr_block = "10.0.0.0/16"
  # ...other variables per address plan
}

# IAM, DynamoDB, S3, Lambda, etc. modules instantiated here
```

---

## 7. Bootstrapping and Apply

**First-time apply:**
```bash
cd environments/prod
terraform init
terraform plan
terraform apply
```

- After first apply, all state is in S3, locking is managed by DynamoDB.
- **Never modify state manually!** All changes must be made via Terraform and PR.

---

## 8. Enforcing Naming, Tagging, and Policy

- Every resource in Terraform **must** use variables or templates for `Name`, `Environment`, `Owner`, `Purpose`, `Project`
- Example tag block for all resources:
```hcl
tags = {
  Name        = var.name
  Environment = var.env
  Owner       = var.owner
  Purpose     = var.purpose
  Project     = "VirtualAgentics"
}
```

---

## 9. CI/CD Integration

- **GitHub Actions** workflow (`.github/workflows/terraform.yml`) configured to:
  - Use OIDC to assume `va-prod-core-terraform-iam-role`
  - Run `terraform fmt`, `terraform plan`, and `terraform apply` on PR/merge to `main`
  - Output plan as PR comment for review/approval
- No static AWS credentials in repo or runners

---

## 10. References and Linked Documents

- [AWS_Control_Tower_Setup.md](AWS_Control_Tower_Setup.md)
- [Naming_Conventions.md](../Naming_Conventions.md)
- [AWS_Addressing_Plan.md](../AWS_Addressing_Plan.md)
- [GitHub_Repository_Structure.md](../GitHub_Repository_Structure.md)
- Source: "Virtual Agentics Phase 1 Terraform Bootstrapping.pdf"

---

*End of document*
